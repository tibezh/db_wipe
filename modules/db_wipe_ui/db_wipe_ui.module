<?php

/**
 * @file
 * DB Wipe UI module file.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function db_wipe_ui_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.db_wipe_ui':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The DB Wipe UI module provides a web-based user interface for deleting entities from your Drupal database. It offers a safer, more visual alternative to Drush commands with multiple confirmation steps and strong safety features.') . '</p>';
      $output .= '<p class="messages messages--error">' . t('<strong>‚ö†Ô∏è CRITICAL WARNING:</strong> This module allows permanent deletion of data through a web interface. Only grant access to highly trusted administrators who understand the consequences.') . '</p>';

      $output .= '<h3>' . t('Accessing the Interface') . '</h3>';
      $output .= '<p>' . t('Navigate to: <strong>Configuration ‚Üí Development ‚Üí Entity Wipe</strong>') . '</p>';
      $output .= '<p>' . t('Direct URL: <a href=":url">/admin/config/development/entity-wipe</a>', [':url' => '/admin/config/development/entity-wipe']) . '</p>';
      $output .= '<p>' . t('Requires the "Administer Entity Wipe" permission, which is restricted to trusted administrators only.') . '</p>';

      $output .= '<h3>' . t('Using the Interface') . '</h3>';
      $output .= '<h4>' . t('Step 1: Configure Deletion') . '</h4>';
      $output .= '<ol>';
      $output .= '<li><strong>' . t('Select Entity Type:') . '</strong> ' . t('Choose what to delete (Content/Nodes, Users, Taxonomy Terms, Media, Comments, etc.)') . '</li>';
      $output .= '<li><strong>' . t('Select Bundle/Type (Optional):') . '</strong> ' . t('Filter by specific type like Article, Page, or Tags. Bundle options load automatically via AJAX based on your entity type selection.') . '</li>';
      $output .= '<li><strong>' . t('Apply Filters (Optional):') . '</strong> ' . t('Click "Show Advanced Filters" to access:') . '</li>';
      $output .= '<ul>';
      $output .= '<li>' . t('<strong>Exclude IDs:</strong> Comma-separated list of entity IDs to protect (e.g., 1,2,3)') . '</li>';
      $output .= '<li>' . t('<strong>Include Only These IDs:</strong> Only delete these specific IDs (e.g., 100,101,102)') . '</li>';
      $output .= '<li>' . t('Note: You cannot use both exclude and include at the same time') . '</li>';
      $output .= '</ul>';
      $output .= '<li><strong>' . t('Dry Run Mode (Enabled by Default):') . '</strong> ' . t('Leave this checked to preview what would be deleted without making any changes. <strong>ALWAYS preview first!</strong>') . '</li>';
      $output .= '</ol>';

      $output .= '<h4>' . t('Step 2: Preview Results') . '</h4>';
      $output .= '<p>' . t('Click the <strong>"Preview Deletion"</strong> button.') . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('<strong>With Dry Run enabled:</strong> Shows count and lists entity IDs (first 100) without deleting anything. Safe to test your filters.') . '</li>';
      $output .= '<li>' . t('<strong>With Dry Run disabled:</strong> Redirects to a confirmation page with critical warnings.') . '</li>';
      $output .= '</ul>';

      $output .= '<h4>' . t('Step 3: Confirm Deletion (Dry Run Disabled Only)') . '</h4>';
      $output .= '<p>' . t('The confirmation page displays:') . '</p>';
      $output .= '<ol>';
      $output .= '<li>' . t('Large critical warning banner (impossible to miss)') . '</li>';
      $output .= '<li>' . t('Complete summary of deletion parameters') . '</li>';
      $output .= '<li>' . t('Text confirmation field - you must type <strong>DELETE</strong> exactly (capital letters required)') . '</li>';
      $output .= '<li>' . t('Red "Yes, DELETE permanently" button and cancel link') . '</li>';
      $output .= '</ol>';
      $output .= '<p>' . t('Type <strong>DELETE</strong> and click the button to proceed with deletion.') . '</p>';

      $output .= '<h4>' . t('Step 4: Batch Processing') . '</h4>';
      $output .= '<p>' . t('Deletion runs in the background using Drupal\'s batch API. A progress bar shows the current status. A success message appears when complete.') . '</p>';

      $output .= '<h3>' . t('Usage Examples') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Delete all Article nodes') . '</dt>';
      $output .= '<dd><ol>';
      $output .= '<li>' . t('Entity Type: Content (Nodes)') . '</li>';
      $output .= '<li>' . t('Bundle/Type: Article') . '</li>';
      $output .= '<li>' . t('Dry Run: ‚úì Enabled') . '</li>';
      $output .= '<li>' . t('Preview Deletion ‚Üí Review the IDs') . '</li>';
      $output .= '<li>' . t('Go back, uncheck Dry Run') . '</li>';
      $output .= '<li>' . t('Preview Deletion ‚Üí Confirmation page') . '</li>';
      $output .= '<li>' . t('Type DELETE ‚Üí Confirm') . '</li>';
      $output .= '</ol></dd>';
      $output .= '<dt>' . t('Delete specific nodes by ID') . '</dt>';
      $output .= '<dd><ol>';
      $output .= '<li>' . t('Entity Type: Content (Nodes)') . '</li>';
      $output .= '<li>' . t('Show Advanced Filters') . '</li>';
      $output .= '<li>' . t('Include Only These IDs: 100,101,102') . '</li>';
      $output .= '<li>' . t('Preview first, then confirm') . '</li>';
      $output .= '</ol></dd>';
      $output .= '<dt>' . t('Delete all taxonomy terms in Tags vocabulary') . '</dt>';
      $output .= '<dd><ol>';
      $output .= '<li>' . t('Entity Type: Taxonomy Terms') . '</li>';
      $output .= '<li>' . t('Bundle/Type: Tags') . '</li>';
      $output .= '<li>' . t('Preview first, then confirm') . '</li>';
      $output .= '</ol></dd>';
      $output .= '</dl>';

      $output .= '<h3>' . t('Safety Features') . '</h3>';
      $output .= '<h4>' . t('User Protection') . '</h4>';
      $output .= '<ul>';
      $output .= '<li><strong>' . t('üõ°Ô∏è User ID 1 Automatic Protection:') . '</strong> ' . t('User ID 1 (admin) is ALWAYS protected and cannot be deleted, even if explicitly included in "Include IDs". This prevents system lockout.') . '</li>';
      $output .= '<li>' . t('A special warning message appears when User entity type is selected') . '</li>';
      $output .= '</ul>';

      $output .= '<h4>' . t('Multiple Confirmation Layers') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Two-step process: configuration form ‚Üí confirmation page') . '</li>';
      $output .= '<li>' . t('Must explicitly disable Dry Run to proceed') . '</li>';
      $output .= '<li>' . t('Must type "DELETE" exactly (case-sensitive)') . '</li>';
      $output .= '<li>' . t('Session-based temporary storage prevents CSRF attacks') . '</li>';
      $output .= '</ul>';

      $output .= '<h4>' . t('Visual Warnings') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Warning banner on main form') . '</li>';
      $output .= '<li>' . t('Large critical warning box on confirmation page') . '</li>';
      $output .= '<li>' . t('Special warnings for user deletion') . '</li>';
      $output .= '<li>' . t('Red danger-styled confirmation button') . '</li>';
      $output .= '<li>' . t('Custom CSS styling for maximum visibility') . '</li>';
      $output .= '</ul>';

      $output .= '<h4>' . t('Technical Safeguards') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Permission restricted (marked as dangerous)') . '</li>';
      $output .= '<li>' . t('Batch processing prevents timeouts and memory issues') . '</li>';
      $output .= '<li>' . t('Event dispatching allows other modules to prevent operations') . '</li>';
      $output .= '<li>' . t('Preview mode enabled by default') . '</li>';
      $output .= '<li>' . t('Session expiration after 1 hour') . '</li>';
      $output .= '</ul>';

      $output .= '<h3>' . t('Permissions') . '</h3>';
      $output .= '<p>' . t('Permission: <strong>"Administer Entity Wipe"</strong>') . '</p>';
      $output .= '<p>' . t('This permission is marked as <strong>restricted access</strong> (dangerous). Only grant it to highly trusted administrators who:') . '</p>';
      $output .= '<ul>';
      $output .= '<li>' . t('Understand that deletion is permanent') . '</li>';
      $output .= '<li>' . t('Know when to backup the database') . '</li>';
      $output .= '<li>' . t('Are authorized to delete production data') . '</li>';
      $output .= '</ul>';
      $output .= '<p><strong>' . t('Grant permission via UI:') . '</strong></p>';
      $output .= '<ol>';
      $output .= '<li>' . t('Navigate to: People ‚Üí Permissions') . '</li>';
      $output .= '<li>' . t('Find "Administer Entity Wipe" permission') . '</li>';
      $output .= '<li>' . t('Check the box for trusted role only (e.g., Administrator)') . '</li>';
      $output .= '<li>' . t('Save permissions') . '</li>';
      $output .= '</ol>';
      $output .= '<p><strong>' . t('Grant permission via Drush:') . '</strong></p>';
      $output .= '<p><code>drush role:perm:add administrator "administer entity wipe"</code></p>';

      $output .= '<h3>' . t('Interface Features') . '</h3>';
      $output .= '<h4>' . t('Main Form Features') . '</h4>';
      $output .= '<ul>';
      $output .= '<li><strong>' . t('AJAX Bundle Loading:') . '</strong> ' . t('Bundle/type options update automatically when you change entity type') . '</li>';
      $output .= '<li><strong>' . t('Collapsible Filters:') . '</strong> ' . t('Advanced options are hidden by default for a cleaner interface') . '</li>';
      $output .= '<li><strong>' . t('Dry Run Default:') . '</strong> ' . t('Safety first - you must explicitly disable preview mode') . '</li>';
      $output .= '<li><strong>' . t('Clear Labels:') . '</strong> ' . t('Helpful descriptions on all fields') . '</li>';
      $output .= '<li><strong>' . t('Warning Banner:') . '</strong> ' . t('Always visible at the top of the form') . '</li>';
      $output .= '</ul>';

      $output .= '<h4>' . t('Confirmation Form Features') . '</h4>';
      $output .= '<ul>';
      $output .= '<li><strong>' . t('ASCII Banner:') . '</strong> ' . t('Large critical warning similar to Drush commands') . '</li>';
      $output .= '<li><strong>' . t('Summary List:') . '</strong> ' . t('All deletion parameters clearly listed') . '</li>';
      $output .= '<li><strong>' . t('Text Confirmation:') . '</strong> ' . t('Must type DELETE to proceed') . '</li>';
      $output .= '<li><strong>' . t('Danger Button:') . '</strong> ' . t('Visually distinct red button') . '</li>';
      $output .= '<li><strong>' . t('Easy Cancel:') . '</strong> ' . t('Prominent cancel option to go back') . '</li>';
      $output .= '</ul>';

      $output .= '<h3>' . t('UI vs Drush Comparison') . '</h3>';
      $output .= '<table>';
      $output .= '<thead><tr><th>Feature</th><th>UI</th><th>Drush</th></tr></thead>';
      $output .= '<tbody>';
      $output .= '<tr><td><strong>Two-step confirmation</strong></td><td>‚úÖ Yes</td><td>‚ùå No</td></tr>';
      $output .= '<tr><td><strong>Must type DELETE</strong></td><td>‚úÖ Yes</td><td>‚ùå No</td></tr>';
      $output .= '<tr><td><strong>Visual warnings</strong></td><td>‚úÖ Yes</td><td>‚úÖ Yes (text)</td></tr>';
      $output .= '<tr><td><strong>Dry run default</strong></td><td>‚úÖ Yes</td><td>‚úÖ Yes</td></tr>';
      $output .= '<tr><td><strong>Preview entity IDs</strong></td><td>‚úÖ In browser</td><td>‚úÖ In CLI</td></tr>';
      $output .= '<tr><td><strong>Session safety</strong></td><td>‚úÖ Yes</td><td>N/A</td></tr>';
      $output .= '<tr><td><strong>Large datasets</strong></td><td>‚ö†Ô∏è May timeout</td><td>‚úÖ Better</td></tr>';
      $output .= '<tr><td><strong>Automation</strong></td><td>‚ùå No</td><td>‚úÖ Yes (--yes)</td></tr>';
      $output .= '<tr><td><strong>Ease of use</strong></td><td>‚úÖ Visual</td><td>‚ö†Ô∏è CLI only</td></tr>';
      $output .= '</tbody>';
      $output .= '</table>';

      $output .= '<h4>' . t('When to Use UI') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Interactive deletion with visual feedback') . '</li>';
      $output .= '<li>' . t('When you want the strongest safety features') . '</li>';
      $output .= '<li>' . t('Learning what entities exist in your site') . '</li>';
      $output .= '<li>' . t('One-off deletion tasks') . '</li>';
      $output .= '<li>' . t('When working with non-technical administrators') . '</li>';
      $output .= '</ul>';

      $output .= '<h4>' . t('When to Use Drush') . '</h4>';
      $output .= '<ul>';
      $output .= '<li>' . t('Very large datasets (> 10,000 entities)') . '</li>';
      $output .= '<li>' . t('Automated/scripted deletions') . '</li>';
      $output .= '<li>' . t('CI/CD pipelines and deployment scripts') . '</li>';
      $output .= '<li>' . t('Faster batch processing') . '</li>';
      $output .= '<li>' . t('When SSH/CLI access is available') . '</li>';
      $output .= '</ul>';

      $output .= '<h3>' . t('Events') . '</h3>';
      $output .= '<p>' . t('The UI module uses the same event system as Drush commands:') . '</p>';
      $output .= '<ul>';
      $output .= '<li><code>EntityWipeEvents::BEFORE_WIPE</code> - ' . t('Before deletion starts') . '</li>';
      $output .= '<li><code>EntityWipeEvents::BATCH_PROCESS</code> - ' . t('During batch processing') . '</li>';
      $output .= '<li><code>EntityWipeEvents::AFTER_WIPE</code> - ' . t('After deletion completes') . '</li>';
      $output .= '</ul>';
      $output .= '<p>' . t('Event subscribers can prevent operations, log actions, or perform cleanup. See the db_wipe_entity module help for details on implementing event subscribers.') . '</p>';

      $output .= '<h3>' . t('Troubleshooting') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Error: "You do not have permission to access this page"') . '</dt>';
      $output .= '<dd>' . t('You need the "Administer Entity Wipe" permission. Ask a site administrator to grant it to your role.') . '</dd>';
      $output .= '<dt>' . t('Error: "Session expired"') . '</dt>';
      $output .= '<dd>' . t('You waited too long between the preview and confirmation steps. Sessions expire after 1 hour. Start over from the main form.') . '</dd>';
      $output .= '<dt>' . t('Error: "No entities found"') . '</dt>';
      $output .= '<dd>' . t('Your filters don\'t match any entities. Check your entity type and bundle selection, or remove filters.') . '</dd>';
      $output .= '<dt>' . t('Batch processing timeout') . '</dt>';
      $output .= '<dd>' . t('Dataset is too large for web interface. Use Drush commands instead for better performance: <code>drush db:wipe-entities [type] --bundle=[bundle]</code>') . '</dd>';
      $output .= '<dt>' . t('Cannot type DELETE in confirmation field') . '</dt>';
      $output .= '<dd>' . t('Browser autocomplete may be interfering. Type manually (don\'t paste). The word must be in capital letters: DELETE') . '</dd>';
      $output .= '<dt>' . t('Bundle dropdown doesn\'t update') . '</dt>';
      $output .= '<dd>' . t('JavaScript may be disabled or AJAX failed. Try clearing cache: <code>drush cr</code>. Check browser console for errors.') . '</dd>';
      $output .= '<dt>' . t('User ID 1 still exists after deletion') . '</dt>';
      $output .= '<dd>' . t('This is intentional! User ID 1 is always protected to prevent system lockout, even if you include it in the "Include IDs" field.') . '</dd>';
      $output .= '</dl>';

      $output .= '<h3>' . t('Best Practices') . '</h3>';
      $output .= '<ol>';
      $output .= '<li><strong>' . t('ALWAYS backup your database before disabling Dry Run') . '</strong></li>';
      $output .= '<li><strong>' . t('ALWAYS use Dry Run first to preview what will be deleted') . '</strong></li>';
      $output .= '<li>' . t('Review the entity IDs in the preview carefully') . '</li>';
      $output .= '<li>' . t('Test on development/staging environments first') . '</li>';
      $output .= '<li>' . t('Only grant permission to highly trusted administrators') . '</li>';
      $output .= '<li>' . t('For large datasets (> 10,000 entities), use Drush instead of UI') . '</li>';
      $output .= '<li>' . t('Monitor the batch processing completion') . '</li>';
      $output .= '<li>' . t('Check Drupal logs after deletion for any issues') . '</li>';
      $output .= '<li>' . t('User ID 1 is automatically protected - no need to manually exclude it') . '</li>';
      $output .= '</ol>';

      $output .= '<h3>' . t('Technical Details') . '</h3>';
      $output .= '<p>' . t('The UI module integrates with the core DB Wipe system:') . '</p>';
      $output .= '<ul>';
      $output .= '<li><strong>' . t('Service:') . '</strong> ' . t('Uses <code>db_wipe.entity_wipe</code> service') . '</li>';
      $output .= '<li><strong>' . t('Session Storage:') . '</strong> ' . t('Uses private tempstore for secure session data') . '</li>';
      $output .= '<li><strong>' . t('Batch API:') . '</strong> ' . t('Leverages Drupal core batch processing') . '</li>';
      $output .= '<li><strong>' . t('Events:') . '</strong> ' . t('Same event system as Drush commands') . '</li>';
      $output .= '<li><strong>' . t('Form API:') . '</strong> ' . t('Standard Drupal form with AJAX callbacks') . '</li>';
      $output .= '<li><strong>' . t('Custom CSS:') . '</strong> ' . t('Included library for enhanced warning styling') . '</li>';
      $output .= '</ul>';

      $output .= '<h3>' . t('Testing') . '</h3>';
      $output .= '<p>' . t('The UI module includes comprehensive functional tests covering all features and safety mechanisms. See the README.md file in the module directory for test coverage details.') . '</p>';

      $output .= '<h3>' . t('Related Modules') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('<a href=":url">DB Wipe (Core)</a> - Plugin system architecture and overview', [':url' => '/admin/help/db_wipe']) . '</li>';
      $output .= '<li>' . t('<a href=":url">DB Wipe Entity</a> - Entity deletion details and events', [':url' => '/admin/help/db_wipe_entity']) . '</li>';
      $output .= '<li>' . t('<a href=":url">DB Wipe Database</a> - Fast table truncation (not available in UI)', [':url' => '/admin/help/db_wipe_db']) . '</li>';
      $output .= '</ul>';

      $output .= '<h3>' . t('Resources') . '</h3>';
      $output .= '<ul>';
      $output .= '<li>' . t('UI Module README: modules/db_wipe_ui/README.md') . '</li>';
      $output .= '<li>' . t('Core README: Complete documentation with code examples') . '</li>';
      $output .= '<li>' . t('Test examples: modules/db_wipe_ui/tests/') . '</li>';
      $output .= '</ul>';

      return $output;
  }
}
