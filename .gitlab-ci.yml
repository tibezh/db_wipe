stages:
  - build
  - test
  - analyze
  - deploy

variables:
  COMPOSER_MEMORY_LIMIT: "-1"
  COMPOSER_CACHE_DIR: "$CI_PROJECT_DIR/.composer"
  MYSQL_DATABASE: drupal
  MYSQL_ROOT_PASSWORD: root
  MYSQL_USER: drupal
  MYSQL_PASSWORD: drupal
  SIMPLETEST_DB: "mysql://drupal:drupal@mariadb/drupal"
  SIMPLETEST_BASE_URL: "http://localhost:8888"
  BROWSERTEST_OUTPUT_DIRECTORY: "/tmp"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .composer/
    - vendor/

# Build stage
composer:install:
  stage: build
  image: composer:2
  script:
    - composer validate --strict
    - composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader
  artifacts:
    paths:
      - vendor/
    expire_in: 1 hour

# Test stage
phpcs:
  stage: test
  image: php:8.2-cli
  needs:
    - composer:install
  before_script:
    - apt-get update && apt-get install -y git unzip libzip-dev
    - docker-php-ext-install zip pdo_mysql
  script:
    - vendor/bin/phpcs --standard=phpcs.xml.dist --report=junit --report-file=phpcs-report.xml
  artifacts:
    reports:
      junit: phpcs-report.xml
    when: always

phpstan:
  stage: analyze
  image: php:8.2-cli
  needs:
    - composer:install
  services:
    - name: mariadb:10.6
      alias: mariadb
  before_script:
    - apt-get update && apt-get install -y git unzip libzip-dev default-mysql-client
    - docker-php-ext-install zip pdo_mysql
    - |
      # Setup Drupal for PHPStan
      composer create-project drupal/recommended-project:10.3.x drupal --no-install --no-interaction
      cd drupal
      composer config minimum-stability dev
      composer config prefer-stable true
      composer config repositories.0 path "../"
      composer require drupal/db_wipe:* --no-update
      composer require drupal/coder mglaman/phpstan-drupal phpstan/phpstan --dev --no-update
      composer update --no-progress --no-interaction
  script:
    - cd drupal
    - cp ../phpstan.neon .
    - cp ../phpstan-bootstrap.php .
    - sed -i 's|/var/www/html/web|web|g' phpstan.neon
    - vendor/bin/phpstan analyze web/modules/contrib/db_wipe --memory-limit=256M --error-format=junit > ../phpstan-report.xml
  artifacts:
    reports:
      junit: phpstan-report.xml
    when: always

phpunit:kernel:
  stage: test
  image: drupalci/php-8.2-apache:production
  needs:
    - composer:install
  services:
    - name: mariadb:10.6
      alias: mariadb
  before_script:
    - |
      # Install Drupal
      composer create-project drupal/recommended-project:10.3.x drupal --no-interaction
      cd drupal
      composer config minimum-stability dev
      composer config prefer-stable true
      composer config repositories.0 path "../"
      composer require drupal/db_wipe:* --no-update
      composer update --no-progress --no-interaction

      # Install Drupal site
      vendor/bin/drush site:install standard --yes \
        --db-url=$SIMPLETEST_DB \
        --site-name="DB Wipe Test" \
        --account-name=admin \
        --account-pass=admin

      # Enable modules
      vendor/bin/drush pm:enable db_wipe db_wipe_entity db_wipe_ui --yes
  script:
    - cd drupal
    - |
      vendor/bin/phpunit -c web/core/phpunit.xml.dist \
        --bootstrap web/core/tests/bootstrap.php \
        --testsuite kernel \
        --group db_wipe \
        --log-junit ../phpunit-kernel-report.xml \
        web/modules/contrib/db_wipe/tests/
  artifacts:
    reports:
      junit: phpunit-kernel-report.xml
    when: always

phpunit:unit:
  stage: test
  image: drupalci/php-8.2-apache:production
  needs:
    - composer:install
  before_script:
    - |
      # Install Drupal
      composer create-project drupal/recommended-project:10.3.x drupal --no-interaction
      cd drupal
      composer config minimum-stability dev
      composer config prefer-stable true
      composer config repositories.0 path "../"
      composer require drupal/db_wipe:* --no-update
      composer update --no-progress --no-interaction
  script:
    - cd drupal
    - |
      vendor/bin/phpunit -c web/core/phpunit.xml.dist \
        --bootstrap web/core/tests/bootstrap.php \
        --testsuite unit \
        --group db_wipe \
        --log-junit ../phpunit-unit-report.xml \
        web/modules/contrib/db_wipe/tests/
  artifacts:
    reports:
      junit: phpunit-unit-report.xml
    when: always

security:check:
  stage: analyze
  image: composer:2
  needs:
    - composer:install
  script:
    - composer audit --format=json > security-report.json
  artifacts:
    reports:
      dependency_scanning: security-report.json
    when: always
  allow_failure: true

# Deploy stage (only on tags)
package:release:
  stage: deploy
  image: alpine:latest
  only:
    - tags
  script:
    - apk add --no-cache tar zip
    # Remove development files
    - rm -rf .github .git tests phpstan.neon phpstan-bootstrap.php phpcs.xml.dist
    - rm -rf .gitlab-ci.yml Makefile .composer vendor
    # Create archives
    - tar -czf db_wipe-${CI_COMMIT_TAG}.tar.gz *
    - zip -r db_wipe-${CI_COMMIT_TAG}.zip * -x "*.git*"
  artifacts:
    paths:
      - "*.tar.gz"
      - "*.zip"
    expire_in: never

# Matrix testing for different PHP/Drupal versions
.test_template: &test_definition
  stage: test
  services:
    - name: mariadb:10.6
      alias: mariadb
  before_script:
    - |
      composer create-project drupal/recommended-project:${DRUPAL_VERSION} drupal --no-interaction
      cd drupal
      composer config minimum-stability dev
      composer config prefer-stable true
      composer config repositories.0 path "../"
      composer require drupal/db_wipe:* --no-update
      composer update --no-progress --no-interaction

      vendor/bin/drush site:install standard --yes \
        --db-url=$SIMPLETEST_DB \
        --site-name="DB Wipe Test" \
        --account-name=admin \
        --account-pass=admin

      vendor/bin/drush pm:enable db_wipe db_wipe_entity db_wipe_ui --yes
  script:
    - cd drupal
    - |
      vendor/bin/phpunit -c web/core/phpunit.xml.dist \
        --bootstrap web/core/tests/bootstrap.php \
        --group db_wipe \
        web/modules/contrib/db_wipe/tests/

test:php82:drupal10:
  <<: *test_definition
  image: drupalci/php-8.2-apache:production
  variables:
    DRUPAL_VERSION: "10.3.x"

test:php83:drupal10:
  <<: *test_definition
  image: drupalci/php-8.3-apache:production
  variables:
    DRUPAL_VERSION: "10.3.x"

test:php83:drupal11:
  <<: *test_definition
  image: drupalci/php-8.3-apache:production
  variables:
    DRUPAL_VERSION: "11.0.x"